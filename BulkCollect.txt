PROCEDURE P_NRI_INVESOTR_DETAILS(
    P_FROM_DATE DATE,
    P_TO_DATE   DATE,
    P_FLAG      VARCHAR2)
AS
TYPE TYPETBL
IS
  TABLE OF DS_KPMG_NRI_INVESTOR_DETAILS%ROWTYPE;
  V_NRIREC TYPETBL;
TYPE CURSOR_TYPE
IS
  REF
  CURSOR;
    C_NRIREC CURSOR_TYPE;
  BEGIN
    BEGIN
      DELETE
      FROM
        DS_KPMG_NRI_INVESTOR_DETAILS;
    COMMIT;
  END;
  BEGIN
    UPDATE
      DS_REP_REPORT_MASTER
    SET
      RSTATUS   = 'R',
      STATUS    = 'Running',
      STARTTIME = SYSDATE,
      ENDTIME   = NULL
    WHERE
      REPID = 5032;
    COMMIT;
  END;
  BEGIN
    OPEN C_NRIREC FOR SELECT CDT.UNITHOLDERID
  AS
    FOLIO_NO,
    SBFS_UNITHOLDER_DETAILS (CDT.UNITHOLDERID,'NAME')
  AS
    INVESTOR_NAME,
    CDT.FUNDID
  AS
    SCHEME,
    FDT.FUNDNAME
  AS
    SCHEME_NAME,
    CASE
    WHEN CDT.TRANSACTIONTYPE = '01' AND CDT.REFTYPE = '01' THEN
      'NFO'
    WHEN CDT.TRANSACTIONTYPE = '01' AND CDT.REFTYPE = 'DS' THEN
      'NFO-SWITCH'
    WHEN CDT.TRANSACTIONTYPE = '02' AND CDT.REFTYPE = '02' THEN
      'SUBSCRIPTION'
    WHEN CDT.TRANSACTIONTYPE = '02' AND CDT.REFTYPE = '31' THEN
      'STP IN'
    WHEN CDT.TRANSACTIONTYPE = '02' AND CDT.REFTYPE = '41' THEN
      'SIP'
    WHEN CDT.TRANSACTIONTYPE = '02' AND CDT.REFTYPE = 'DS' THEN
      'SWITCH IN'
    END
  AS
    TRANSACTIONTYPE,
    CDT.TRANSACTIONNUMBER
  AS
    TRANSACTIONUMBER,
    SBFS_UNITHOLDER_DETAILS (CDT.UNITHOLDERID,'TAXSTATUS')
  AS
    TAX_STATUS,
    (
      SELECT
        MLM.LOCATION_NAME
      FROM
        MIS_LOCATION_MASTER MLM
      WHERE
        MLM.LOC_CODE (+)= UHAT.OTHERINFO26
    )
  AS
    LOCATION_CODE,
    CDT.NETAMTINFBCCY
  AS
    AMOUNT,
    CDT.UNITSCONFIRMED
  AS
    UNITS,
    TO_CHAR(CDT.TRANSACTIONDATE,'DD-MON-YYYY')
  AS
    TRANSACTIONDATE,
    TO_CHAR(CDT.DATEALLOTED,'DD-MON-YYYY')
  AS
    DATEALLOTED,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_ADDRESS1')
  AS
    CO_ADDRESS1,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_ADDRESS2')
  AS
    CO_ADDRESS2,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_ADDRESS3')
  AS
    CO_ADDRESS3,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_ADDRESS4')
  AS
    CO_ADDRESS4,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_ADDRESS3')
  AS
    CO_CITY,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_PINCODE')
  AS
    CO_PINCODE,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_ADDRESS4')
  AS
    CO_STATE,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_COUNTRY')
  AS
    CO_COUNTRY,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'CO_COUNTRY_CODE')
  AS
    CO_COUNTRY_CODE,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_ADDRESS1')
  AS
    AL_ADDRESS1,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_ADDRESS2')
  AS
    AL_ADDRESS2,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_ADDRESS3')
  AS
    AL_ADDRESS3,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_ADDRESS4')
  AS
    AL_ADDRESS4,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_ADDRESS3')
  AS
    AL_CITY,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_PINCODE')
  AS
    AL_PINCODE,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_ADDRESS4')
  AS
    AL_STATE,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_COUNTRY')
  AS
    AL_COUNTRY,
    SBFS_UH_ADDRESS_DETAILS (CDT.UNITHOLDERID,'ALT_COUNTRY_CODE')
  AS
    AL_COUNTRY_CODE,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_CO_ADDRESS1',UHT.TAXID)
  AS
    KRA_CO_ADDRESS1 ,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_CO_ADDRESS2',UHT.TAXID)
  AS
    KRA_CO_ADDRESS2 ,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_CO_ADDRESS3',UHT.TAXID)
  AS
    KRA_CO_ADDRESS3 ,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_CO_CITY',UHT.TAXID)
  AS
    KRA_CO_CITY,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_CO_PINCODE',UHT.TAXID)
  AS
    KRA_CO_PINCODE,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_CO_STATE',UHT.TAXID)
  AS
    KRA_CO_STATE,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_COUNTRY',UHT.TAXID)
  AS
    KRA_CO_COUNTRY ,
    SBFS_UH_ADDRESS_DETAILS (NULL,'KRA_COUNTRY_CODE',UHT.TAXID)
  AS
    KRA_CO_COUNTRY_CODE FROM CONSOLIDATEDTXNTBL CDT,
    (
      SELECT
        FUNDID,
        FUNDNAME,
        MAX(RULEEFFECTIVEDATE)
      FROM
        FUNDDEMOGRAPHICSTBL
      WHERE
        AUTH_STAT = 'A'
      GROUP BY
        FUNDID,
        FUNDNAME
    )
    FDT,
    UNITHOLDERADDINFOTBL UHAT,
    UNITHOLDERTBL UHT WHERE CDT.DATEALLOTED BETWEEN P_FROM_DATE AND P_TO_DATE
    AND CDT.FUNDID       = FDT.FUNDID AND CDT.TRANSACTIONTYPE IN ('01','02') AND
    CDT.REFTYPE         <> 'RE' AND UHAT.UNITHOLDERID (+) = CDT.UNITHOLDERID AND
    UHT.UNITHOLDERID (+) = CDT.UNITHOLDERID AND
    (
      P_FLAG = 'NRI' AND UHT.UHCATEGORY IN ('28','26','05','04' ,'29','27',
      'NR'
      ) OR P_FLAG = 'ALL' AND UHT.UHCATEGORY IN (
      (
        SELECT DISTINCT
          PARAMVALUE
        FROM
          PARAMSTBL
        WHERE
          PARAMCODE IN ('CORPINVCATEGORY','INDINVCATEGORY')
      )
        )
    )
    ;
    LOOP
      FETCH
        C_NRIREC BULK COLLECT
      INTO
        V_NRIREC LIMIT 1000;
      IF V_NRIREC.COUNT > 0 THEN
        FORALL I IN 1..V_NRIREC.COUNT
        INSERT
        INTO
          DS_KPMG_NRI_INVESTOR_DETAILS VALUES V_NRIREC
          (
            I
          );
      END IF;
      COMMIT;
      IF C_NRIREC%NOTFOUND THEN
        EXIT;
      END IF;
    END LOOP;
  EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
  END;
BEGIN
  UPDATE
    DS_REP_REPORT_MASTER
  SET
    RSTATUS     = 'C',
    STATUS      = 'Completed',
    DATAEXTRACT = 'NN',
    ENDTIME     = NULL
  WHERE
    REPID = 5032;
  COMMIT;
END;
END P_NRI_INVESOTR_DETAILS;